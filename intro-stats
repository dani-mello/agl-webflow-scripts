console.log("INTRO STATS COUNTER (V2 - ES5 SAFE)");

(function () {
  var root = document.querySelector(".c-intro_stats");
  if (!root) return;

  var counters = root.querySelectorAll(".u-h1[data-count]");
  if (!counters.length) return;

  var prefersReduced = false;
  if (window.matchMedia) {
    prefersReduced = window
      .matchMedia("(prefers-reduced-motion: reduce)")
      .matches;
  }

  function parseCount(raw) {
    var numStr = String(raw).replace(/[^0-9]/g, "");
    var value = parseInt(numStr, 10);
    var suffix = String(raw).replace(/[0-9]/g, "");
    return { value: value, suffix: suffix };
  }

  function animateCount(el) {
    if (el.getAttribute("data-count-init") === "1") return;
    el.setAttribute("data-count-init", "1");

    var raw = el.getAttribute("data-count");
    if (!raw) return;

    var parsed = parseCount(raw);
    var value = parsed.value;
    var suffix = parsed.suffix;

    if (isNaN(value)) {
      console.warn("Invalid data-count:", raw, el);
      return;
    }

    if (prefersReduced) {
      el.textContent = value.toLocaleString() + suffix;
      return;
    }

    var duration = 1200;
    var startTime = new Date().getTime();

    function tick() {
      var now = new Date().getTime();
      var progress = (now - startTime) / duration;
      if (progress > 1) progress = 1;

      // easeOutQuad
      var eased = 1 - Math.pow(1 - progress, 2);
      var current = Math.floor(eased * value);

      el.textContent = current.toLocaleString() + suffix;

      if (progress < 1) {
        window.requestAnimationFrame(tick);
      } else {
        el.textContent = value.toLocaleString() + suffix;
      }
    }

    window.requestAnimationFrame(tick);
  }

  // IntersectionObserver (ES5 compatible usage)
  if ("IntersectionObserver" in window) {
    var observer = new IntersectionObserver(function (entries) {
      for (var i = 0; i < entries.length; i++) {
        if (entries[i].isIntersecting) {
          animateCount(entries[i].target);
          observer.unobserve(entries[i].target);
        }
      }
    }, { threshold: 0.35 });

    for (var j = 0; j < counters.length; j++) {
      observer.observe(counters[j]);
    }
  } else {
    for (var k = 0; k < counters.length; k++) {
      animateCount(counters[k]);
    }
  }
})();
